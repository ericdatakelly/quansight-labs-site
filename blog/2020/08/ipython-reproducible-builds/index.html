<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>IPython reproducible builds | Quansight Labs</title>
<link href="../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../../../rss.xml">
<link rel="canonical" href="https://labs.quansight.org/blog/2020/08/ipython-reproducible-builds/">
<link rel="icon" href="../../../../favicon.ico" sizes="16x16">
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
   tex2jax: {
       inlineMath: [ ['$','$'], ["\\(","\\)"], ],
       displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
   },
   displayAlign: 'center', // Change this to 'center' to center equations.
   "HTML-CSS": {
       styles: {'.MathJax_Display': {"margin": 0}}
   }
});
</script><!--[if lt IE 9]><script src="../../../../assets/js/html5.js"></script><![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-163785882-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-163785882-1');
</script><link rel="stylesheet" type="text/css" href="../../../../assets/css/tipuesearch.css">
<meta name="author" content="Matthias Bussonnier">
<meta property="description" content="Starting with IPython 7.16.1 (released in June 2020), you should be able to recreate the sdist (.tar.gz) and wheel
(.whl), and get byte for byte identical result to the wheels published on PyPI. This ">
<link rel="prev" href="../introducing-versioned-hdf5/" title="Introducing Versioned HDF5" type="text/html">
<link rel="next" href="../what-are-traitlets/" title="Traitlets - an introduction &amp; use in Jupyter configuration management" type="text/html">
<meta property="og:site_name" content="Quansight Labs">
<meta property="og:title" content="IPython reproducible builds">
<meta property="og:url" content="https://labs.quansight.org/blog/2020/08/ipython-reproducible-builds/">
<meta property="og:description" content="Starting with IPython 7.16.1 (released in June 2020), you should be able to recreate the sdist (.tar.gz) and wheel
(.whl), and get byte for byte identical result to the wheels published on PyPI. This ">
<meta property="og:image" content="https://labs.quansight.org/images/QuansightLabs_logo_V2.png">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2020-08-24T12:00:00Z">
<meta property="article:tag" content="IPython">
<meta property="article:tag" content="Labs">
<meta property="article:tag" content="packaging">
<meta property="article:tag" content="reproducible-builds">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@quansightai">
<meta property="twitter:image" content="https://labs.quansight.org/images/QuansightLabs_logo_V2.png">
<link rel="stylesheet" href="../../../../assets/css/quansightlabs.css">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-expand-md static-top mb-4
navbar-dark bg-dark
"><div class="container">
<!-- This keeps the margins nice -->
        <a class="navbar-brand" href="https://labs.quansight.org/">
            <img src="../../../../images/QuansightLabs_logo_V1_white.png" alt="Quansight Labs" id="logo" class="d-inline-block align-top"></a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="bs-navbar">
            <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="../../../../" class="nav-link">Home</a>
                </li>
<li class="nav-item">
<a href="../../../" class="nav-link">Blog</a>
                </li>
<li class="nav-item">
<a href="../../../../team/" class="nav-link">Team</a>
                </li>
<li class="nav-item">
<a href="../../../../projects/" class="nav-link">Projects</a>
                </li>
<li class="nav-item">
<a href="../../../../about/" class="nav-link">About</a>
                </li>
<li class="nav-item">
<a href="../../../../rss.xml" class="nav-link">RSS</a>

                
            </li>
</ul>
<form class="navbar-form navbar-left" action="../../../../search" role="search">
    <div class="form-group">
        <input type="text" class="form-control" id="tipue_search_input" name="q" placeholder="Searchâ€¦" autocomplete="off">
</div>
    <input type="submit" value="Local Search" style="visibility: hidden;"><!-- button type="submit" class="btn btn-default">Submit</button -->
</form>


            <ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name">
                <a href="." class="u-url">IPython reproducible builds</a>
            </h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../../../authors/matthias-bussonnier/">Matthias Bussonnier</a>
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2020-08-24T12:00:00Z" itemprop="datePublished" title="2020-08-24">2020-08-24</time></a>
            </p>
            

        </div>
        
        <ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../../categories/ipython/" rel="tag">IPython</a></li>
            <li><a class="tag p-category" href="../../../../categories/labs/" rel="tag">Labs</a></li>
            <li><a class="tag p-category" href="../../../../categories/packaging/" rel="tag">packaging</a></li>
            <li><a class="tag p-category" href="../../../../categories/reproducible-builds/" rel="tag">reproducible-builds</a></li>
        </ul></header><div class="e-content entry-content" itemprop="articleBody text">
        <div>
<p>Starting with IPython 7.16.1 (released in June 2020), you <em>should</em> be able to recreate the sdist (<code>.tar.gz</code>) and wheel
(<code>.whl</code>), and get byte for byte identical result to the wheels published on PyPI. This is a critical step toward being able
to <em>trust</em> your computing platforms, and a key component to improve efficiency of build and packaging platforms. It also
potentially impacts fast conda environment creation for users. The following goes into some reasons for why you should care.</p>
<!-- TEASER_END -->

<p>Since the cornerstone paper <a href="https://www.cs.cmu.edu/~rdriley/487/papers/Thompson_1984_ReflectionsonTrustingTrust.pdf">Refections on trusting Trust</a>, there have always been advocates of reproducible builds. In
today's highly interconnected world, and with the speed at which new software is released and deployed, being able to confirm
the provenance of build artifacts and verify that the supply chain has not been affected by a malicious actor is often critical. To help in this
endeavour, the movement of <a href="https://reproducible-builds.org/">reproducible builds</a>, attempts to push software toward a deterministic and reproducible
build process.</p>
<p>While information security practitioners were one of the earliest groups who advocated for reproducible builds, there
are a number of other advantages to ensure the same artifacts can be reproduced identically.</p>
<p>For the users of the Scientific Python ecosystem, the notion of reproducibility/replicability is not new, and is one of
the critical ideas behind the scientific process. Given some instructions from an author, you should be able to perform some
experiments or proof, and reach the same conclusion. When you see the opposite, your instructions or hypothesis are missing
some variable elements and your model is incomplete; having a complete model, reproducibility, is one of the necessary
component to be able to trust the results and build upon it. We are not going to enter into the exact distinction
between reproducible and replicable, both have their goals and uses.</p>
<h2>Aren't computers reproducible by design?</h2>
<p>One of the prerequisites for reproducibility is to have a deterministic process, and while we tend to think about computers
as deterministic things, they often are not, and on purpose. Mainly driven by security concerns, a number of processes in
a computer use pseudo-randomness to prevent an attacker from gaining control over a system. Thus by default, many of the
typical actions you may do in a software (iterating over a set in Python, the hash value of strings), will have <em>some</em> randomness in them,
which impact the determinism of a process.</p>
<p>There are of course a number of sources of involuntary randomness due to the practicality of computer systems. These
include: the current date and time, your user name and uid, hostname, order of files on your hard drive and in which
order they may be listed.</p>
<p>To obtain a reproducible result, one thus often needs to make sure each step is deterministic and that all the variables
influencing that process are either controlled or recorded.</p>
<h2>Reproducible artifact build</h2>
<p>In IPython 7.16.1 we have tried to removed all sources of variability, by controlling the order in which the files are
generated, archived in the sdists, their metadata, timestamps, etc. Thus you should be able to go from the commit in the
source repository to the sdist/wheel and obtain an identical result. This should help you to trust that no backdoor has
been introduced in the released packages. It is also critically useful for efficiency in package managers.</p>
<p>Of course you have to trust that the IPython source itself and its dependencies are devoid of backdoors, but let's move
one step at a time. Reproducible build artifacts can also have impact on the build and installation process of packages.</p>
<h2>Efficient rebuilds of dependencies</h2>
<p>Currently IPython depends on many packages: <code>prompt_toolkit</code>, <code>traitlets</code>, <code>setuptools</code>, and more. We also have a number of
downstream packages, like <code>ipykernel</code>, then <code>jupyter notebook</code>. When a dependency tree is rebuilt for one reason or another, a change of a
single bit could trigger the rebuild of the whole chain. When a package like IPython is not reproducible, this means a
rebuild of IPython â€“Â whether it has changed or not â€“Â could trigger a rebuild of all downstream elements.</p>
<p>With a reproducible build, you can trust that the artifact will not change after a rebuild. For the functional programmer
around you: it indicates that the process of building from source is a pure function. Therefore it can safely be part
of a distributed system (rebuilding on two different places will give the same result, so you can avoid costly data
movement), and we can also do caching of results, so for identical input we know the output will be identical.</p>
<p>This can allow breaking rebuild chains by stopping as soon as a dependency rebuild has no effect.</p>
<p>Thus, reproducible builds are a necessary but not sufficient condition to decrease the time spent by platforms like conda-forge on rebuilding the ecosystem
for a new version of Python; making new packages available faster.</p>
<h2>Deduplication</h2>
<p>One rarely mentioned advantage is deduplication. In many cases there are no reasons why artifacts produced by a build
step would depend on <em>all</em> of their inputs. For example IPython has currently no reason to build differently on Python 3.7,
3.8, and the soon-to-be-released 3.9, or on Linux/macOS/Windows. Nevertheless Conda provides no less than 10 downloads for each
release of IPython.</p>
<pre class="code literal-block"><span></span><code>$ diff -U0  &lt;<span class="o">(</span><span class="nb">cd</span> ipython-7.17.0-py37hc6149b9_0/ <span class="p">;</span> fd -tf --full-path  <span class="p">|</span> xargs -L1 md5<span class="o">)</span>  &lt;<span class="o">(</span><span class="nb">cd</span> ipython-7.17.0-py38h1cdfbd6_0/ <span class="p">;</span> fd --full-path  -t f <span class="p">|</span> xargs -L1 md5<span class="o">)</span>
--- /dev/fd/63  <span class="m">2020</span>-08-05 <span class="m">15</span>:15:47.000000000 -0700
+++ /dev/fd/62  <span class="m">2020</span>-08-05 <span class="m">15</span>:15:47.000000000 -0700
@@ -316 +316 @@
-MD5 <span class="o">(</span>Lib/site-packages/ipython-7.17.0.dist-info/RECORD<span class="o">)</span> <span class="o">=</span> 0ebe6e43ae9dcfc29b86338605fc9065
+MD5 <span class="o">(</span>Lib/site-packages/ipython-7.17.0.dist-info/RECORD<span class="o">)</span> <span class="o">=</span> 16f820e051e75462d970be438fbd2b0a
@@ -319 +319 @@
-MD5 <span class="o">(</span>Lib/site-packages/ipython-7.17.0.dist-info/direct_url.json<span class="o">)</span> <span class="o">=</span> 2c37570ef1bd3eadd669649da321b69f
+MD5 <span class="o">(</span>Lib/site-packages/ipython-7.17.0.dist-info/direct_url.json<span class="o">)</span> <span class="o">=</span> b55d0dcd87b11218d41c34d8ee0a5016
@@ -331 +331 @@
-MD5 <span class="o">(</span>info/files<span class="o">)</span> <span class="o">=</span> d24cc180f95193be847116340f1af63a
+MD5 <span class="o">(</span>info/files<span class="o">)</span> <span class="o">=</span> 0161e68902cb78c6b1aec564c0a9e808
@@ -333,2 +333,2 @@
-MD5 <span class="o">(</span>info/hash_input.json<span class="o">)</span> <span class="o">=</span> d25b93fadc7421a297daf02f9a04584f
-MD5 <span class="o">(</span>info/index.json<span class="o">)</span> <span class="o">=</span> 0fb13436b493433c08c9b29c23b76180
+MD5 <span class="o">(</span>info/hash_input.json<span class="o">)</span> <span class="o">=</span> b7c843bd4a6cef64080e893a939e95bd
+MD5 <span class="o">(</span>info/index.json<span class="o">)</span> <span class="o">=</span> 6283e83efc554f9f5b4d4e2330d8ec4e
@@ -336,3 +336,3 @@
-MD5 <span class="o">(</span>info/paths.json<span class="o">)</span> <span class="o">=</span> 06e6ba2378d6eecdfcf08e1c602d392b
-MD5 <span class="o">(</span>info/recipe/conda_build_config.yaml<span class="o">)</span> <span class="o">=</span> 1a98301b552bde7a25c99a39711c9fe2
-MD5 <span class="o">(</span>info/recipe/meta.yaml<span class="o">)</span> <span class="o">=</span> 1a823d7c8c2dac394617482c596f26f0
+MD5 <span class="o">(</span>info/paths.json<span class="o">)</span> <span class="o">=</span> 0a82a812984f98660fbf0244eddeed38
+MD5 <span class="o">(</span>info/recipe/conda_build_config.yaml<span class="o">)</span> <span class="o">=</span> e1c3ae7827bd7003e9034720c7b0f76c
+MD5 <span class="o">(</span>info/recipe/meta.yaml<span class="o">)</span> <span class="o">=</span> 08d5f54df6083bfb834b24b9ae4c4e0f
@@ -342 +342 @@
-MD5 <span class="o">(</span>info/test/test_time_dependencies.json<span class="o">)</span> <span class="o">=</span> a66ce3a62bd757ceede3ad5ef4c2c4b6
+MD5 <span class="o">(</span>info/test/test_time_dependencies.json<span class="o">)</span> <span class="o">=</span> ca1e35258bf3ce4719b090a90f886cd6
</code></pre>


<p>I'm sure <em>some</em> of these changes are necessary as they are related to which Python version the package refers to; but let's
look in more detail at one of those:</p>
<pre class="code literal-block"><span></span><code>$ fd test_time_dependencies.json <span class="p">|</span> xargs diff -U2
--- ipython-7.17.0-py37hc6149b9_0/info/test/test_time_dependencies.json <span class="m">2020</span>-07-31 <span class="m">21</span>:41:11.000000000 -0700
+++ ipython-7.17.0-py38h1cdfbd6_0/info/test/test_time_dependencies.json <span class="m">2020</span>-07-31 <span class="m">21</span>:40:53.000000000 -0700
@@ -1 +1 @@
-<span class="o">[</span><span class="s2">"matplotlib"</span>, <span class="s2">"nbformat"</span>, <span class="s2">"pygments"</span>, <span class="s2">"ipykernel"</span>, <span class="s2">"nose &gt;=0.10.1"</span>, <span class="s2">"trio"</span>, <span class="s2">"numpy"</span>, <span class="s2">"pip"</span>, <span class="s2">"testpath"</span>, <span class="s2">"requests"</span><span class="o">]</span>
+<span class="o">[</span><span class="s2">"requests"</span>, <span class="s2">"numpy"</span>, <span class="s2">"matplotlib"</span>, <span class="s2">"trio"</span>, <span class="s2">"testpath"</span>, <span class="s2">"pip"</span>, <span class="s2">"pygments"</span>, <span class="s2">"nbformat"</span>, <span class="s2">"ipykernel"</span>, <span class="s2">"nose &gt;=0.10.1"</span><span class="o">]</span>
</code></pre>


<p>Here the changes are minor and completely inconsequential for the use of the package; those changes prevent us from
detecting that two builds are actually identical.</p>
<p>This could allow to decrease precious disk space, bandwidth, and time spent waiting for software to install.</p>
<p>If you'd like to learn more about this topic, I'd recommend talking to some <a href="https://nixos.org/">Nix</a> users to see how a purely functional package manager works and
which other advantages this brings.</p>
<p>But in the meantime, please go track the various sources of randomness in your favorite library or build system, and
let's work together to change things so that things never change!</p>
</div>
    </div>
    <aside class="postpromonav"><nav><ul class="pager hidden-print">
<li class="previous">
                <a href="../introducing-versioned-hdf5/" rel="prev" title="Introducing Versioned HDF5">Previous post</a>
            </li>

            <li class="archive">
                <a href="../../../../archive.html" rel="archive" title="Archive ">Archive</a>
            </li>

            <li class="next">
                <a href="../what-are-traitlets/" rel="next" title="Traitlets - an introduction &amp; use in Jupyter configuration management">Next post</a>
            </li>
        </ul></nav></aside></article><!--End of body content--><footer id="footer">
            Contents Â© 2021         <a href="../../../../team">Quansight Labs Team</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="../../../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>
