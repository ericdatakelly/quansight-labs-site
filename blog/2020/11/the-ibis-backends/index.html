<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Querying multiple backends with Ibis | Quansight Labs</title>
<link href="../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../../../rss.xml">
<link rel="canonical" href="https://labs.quansight.org/blog/2020/11/the-ibis-backends/">
<link rel="icon" href="../../../../favicon.ico" sizes="16x16">
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
   tex2jax: {
       inlineMath: [ ['$','$'], ["\\(","\\)"], ],
       displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
   },
   displayAlign: 'center', // Change this to 'center' to center equations.
   "HTML-CSS": {
       styles: {'.MathJax_Display': {"margin": 0}}
   }
});
</script><!--[if lt IE 9]><script src="../../../../assets/js/html5.js"></script><![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-163785882-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-163785882-1');
</script><link rel="stylesheet" type="text/css" href="../../../../assets/css/tipuesearch.css">
<meta name="author" content="Tony Fast, Kim Pevey">
<meta property="description" content="In our recent Ibis post, we discussed querying &amp; retrieving data using a familiar Pandas-like interface.
That discussion focused on the fluent API that Ibis provides to query structure from a SQLite d">
<link rel="prev" href="../manylinux1-is-obsolete-manylinux2010-is-almost-eol-what-is-next/" title="Manylinux1 is obsolete, manylinux2010 is almost EOL, what is next?" type="text/html">
<link rel="next" href="../introduction-to-design-in-open-source/" title="Introduction to Design in Open Source" type="text/html">
<meta property="og:site_name" content="Quansight Labs">
<meta property="og:title" content="Querying multiple backends with Ibis">
<meta property="og:url" content="https://labs.quansight.org/blog/2020/11/the-ibis-backends/">
<meta property="og:description" content="In our recent Ibis post, we discussed querying &amp; retrieving data using a familiar Pandas-like interface.
That discussion focused on the fluent API that Ibis provides to query structure from a SQLite d">
<meta property="og:image" content="https://labs.quansight.org/images/QuansightLabs_logo_V2.png">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2020-11-13T00:00:00-06:00">
<meta property="article:tag" content="Ibis">
<meta property="article:tag" content="OmniSci">
<meta property="article:tag" content="Pandas">
<meta property="article:tag" content="SQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@quansightai">
<meta property="twitter:image" content="https://labs.quansight.org/images/QuansightLabs_logo_V2.png">
<link rel="stylesheet" href="../../../../assets/css/quansightlabs.css">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-expand-md static-top mb-4
navbar-dark bg-dark
"><div class="container">
<!-- This keeps the margins nice -->
        <a class="navbar-brand" href="https://labs.quansight.org/">
            <img src="../../../../images/QuansightLabs_logo_V1_white.png" alt="Quansight Labs" id="logo" class="d-inline-block align-top"></a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="bs-navbar">
            <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="../../../../" class="nav-link">Home</a>
                </li>
<li class="nav-item">
<a href="../../../" class="nav-link">Blog</a>
                </li>
<li class="nav-item">
<a href="../../../../team/" class="nav-link">Team</a>
                </li>
<li class="nav-item">
<a href="../../../../projects/" class="nav-link">Projects</a>
                </li>
<li class="nav-item">
<a href="../../../../about/" class="nav-link">About</a>
                </li>
<li class="nav-item">
<a href="../../../../rss.xml" class="nav-link">RSS</a>

                
            </li>
</ul>
<form class="navbar-form navbar-left" action="../../../../search" role="search">
    <div class="form-group">
        <input type="text" class="form-control" id="tipue_search_input" name="q" placeholder="Search…" autocomplete="off">
</div>
    <input type="submit" value="Local Search" style="visibility: hidden;"><!-- button type="submit" class="btn btn-default">Submit</button -->
</form>


            <ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name">
                <a href="." class="u-url">Querying multiple backends with Ibis</a>
            </h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../../../authors/tony-fast-kim-pevey/">Tony Fast, Kim Pevey</a>
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2020-11-13T00:00:00-06:00" itemprop="datePublished" title="2020-11-13">2020-11-13</time></a>
            </p>
            

        </div>
        
        <ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../../categories/ibis/" rel="tag">Ibis</a></li>
            <li><a class="tag p-category" href="../../../../categories/omnisci/" rel="tag">OmniSci</a></li>
            <li><a class="tag p-category" href="../../../../categories/pandas/" rel="tag">Pandas</a></li>
            <li><a class="tag p-category" href="../../../../categories/sql/" rel="tag">SQL</a></li>
        </ul></header><div class="e-content entry-content" itemprop="articleBody text">
        <div>
<p>In <a href="https://labs.quansight.org/blog/2020/06/ibis-an-idiomatic-flavor-of-sql-for-python-programmers/">our recent Ibis post</a>, we discussed querying &amp; retrieving data using a familiar <a href="http://pandas.pydata.org/">Pandas</a>-like interface.
That discussion focused on the fluent API that <a href="https://www.ibis-project.org/">Ibis</a> provides to query structure from a SQLite database—in particular, using a single specific backend.
In this post, we'll explore Ibis's ability to answer questions about data using two different Ibis backends.</p>
<pre class="code literal-block"><span></span><code><span class="kn">import</span> <span class="nn">ibis.omniscidb</span><span class="o">,</span> <span class="nn">dask</span><span class="o">,</span> <span class="nn">intake</span><span class="o">,</span> <span class="nn">sqlalchemy</span><span class="o">,</span> <span class="nn">pandas</span><span class="o">,</span> <span class="nn">pyarrow</span> <span class="k">as</span> <span class="nn">arrow</span><span class="o">,</span> <span class="nn">altair</span><span class="o">,</span> <span class="nn">h5py</span> <span class="k">as</span> <span class="nn">hdf5</span>
</code></pre>


<h3>Ibis in the scientific Python ecosystem</h3>
<p>Before we delve into the technical details of using Ibis, we'll consider Ibis in the greater historical context of the scientific Python ecosystem. It was started by Wes McKinney, the creator of Pandas, as way to query information on
the <a href="https://en.wikipedia.org/wiki/Apache_Hadoop#HDFS">Hadoop distributed file system</a> and <a href="https://pypi.org/project/pyspark/">PySpark</a>. More backends were added later as Ibis became a general tool for data queries.</p>
<p>Throughout the rest of this post, we'll highlight the ability of Ibis to generically prescribe
query expressions across different data storage systems.</p>
<!-- TEASER_END -->

<h4>The design of Ibis backends</h4>
<p>Currently, Ibis supports more than ten different backends:</p>
<pre class="code literal-block"><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">ibis</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">dir</span><span class="p">(</span><span class="n">ibis</span><span class="p">)</span>
<span class="p">[</span><span class="o">...</span><span class="n">HDFS</span><span class="o">...</span><span class="n">WebHDFS</span><span class="o">...</span><span class="n">bigquery</span><span class="o">...</span><span class="n">clickhouse</span><span class="o">...</span><span class="n">hdf5</span><span class="o">...</span><span class="n">impala</span><span class="o">...</span><span class="n">omniscidb</span><span class="o">...</span><span class="n">pandas</span><span class="o">...</span><span class="n">pyspark</span><span class="o">...</span><span class="n">spark</span><span class="o">...</span><span class="n">sql</span><span class="o">...</span><span class="n">sqlite</span><span class="o">...</span><span class="p">]</span>
</code></pre>


<p>A backend manages the computation of an Ibis query expression; <em>the query expression itself is independent of the computation</em>.
A backend implementation that can be queried with Ibis has one of the three following architectures:</p>
<ol>
<li>Direct execution backends (e.g., Pandas and HDF5);</li>
<li>Expression-generating backends that create SQLAlchemy expressions (e.g., <code>ibis.sql</code>); or</li>
<li>String-generating backends (e.g., <code>ibis.bigquery</code> and <code>ibis.omniscidb</code>)</li>
</ol>
<p>We'll unravel some of the different capabilities of each approach below.</p>
<h3>A data-driven history of Ibis compatibility</h3>
<p>The table below looks at over 2000 issues in the Ibis project.
It provides an annual summary of the issues tagged in Ibis
for different backends over a span of six years.</p>
<table>
<thead><tr>
<th align="left"><div style="width:120px"></div></th>
<th align="center"><div style="width:70px">    2015</div></th>
<th align="center"><div style="width:70px">    2016</div></th>
<th align="center"><div style="width:70px">    2017</div></th>
<th align="center"><div style="width:70px">    2018</div></th>
<th align="center"><div style="width:70px">    2019</div></th>
<th align="center"><div style="width:70px">    2020</div></th>
</tr></thead>
<tbody>
<tr>
<td align="left"><a href="https://www.omnisci.com/">Omnisci</a></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center">31</td>
<td align="center">33</td>
<td align="center">38</td>
</tr>
<tr>
<td align="left"><a href="https://spark.apache.org/">Spark</a></td>
<td align="center"></td>
<td align="center"></td>
<td align="center">1</td>
<td align="center"></td>
<td align="center">22</td>
<td align="center">3</td>
</tr>
<tr>
<td align="left"><a href="https://www.postgresql.org/">PostgreSQL</a></td>
<td align="center">2</td>
<td align="center">3</td>
<td align="center">21</td>
<td align="center">10</td>
<td align="center">17</td>
<td align="center">4</td>
</tr>
<tr>
<td align="left"><a href="https://cloud.google.com/bigquery/">BigQuery</a></td>
<td align="center"></td>
<td align="center"></td>
<td align="center">15</td>
<td align="center">71</td>
<td align="center">12</td>
<td align="center">2</td>
</tr>
<tr>
<td align="left"><a href="http://pandas.pydata.org/">Pandas</a></td>
<td align="center">2</td>
<td align="center"></td>
<td align="center">49</td>
<td align="center">35</td>
<td align="center">32</td>
<td align="center">4</td>
</tr>
<tr>
<td align="left"><a href="https://www.sqlite.org/index.html">SQLite</a></td>
<td align="center">25</td>
<td align="center">2</td>
<td align="center">10</td>
<td align="center">8</td>
<td align="center">1</td>
<td align="center">1</td>
</tr>
<tr>
<td align="left"><a href="https://impala.apache.org/">Impala</a></td>
<td align="center">52</td>
<td align="center">4</td>
<td align="center">15</td>
<td align="center">17</td>
<td align="center">4</td>
<td align="center">2</td>
</tr>
<tr>
<td align="left"><a href="https://kudu.apache.org/">Kudu</a></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center">1</td>
</tr>
<tr>
<td align="left"><a href="http://ibis-project.org/docs/user_guide/geospatial_analysis.html">Geospatial</a></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center">7</td>
<td align="center">3</td>
</tr>
<tr>
<td align="left"><a href="https://clickhouse.tech/">ClickHouse</a></td>
<td align="center"></td>
<td align="center"></td>
<td align="center">8</td>
<td align="center">9</td>
<td align="center">1</td>
<td align="center">4</td>
</tr>
<tr>
<td align="left"><a href="https://www.mysql.com/">MySQL</a></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center">2</td>
<td align="center">2</td>
<td align="center">4</td>
</tr>
<tr>
<td align="left"><a href="https://www.sqlalchemy.org/">SQLAlchemy</a></td>
<td align="center">17</td>
<td align="center">3</td>
<td align="center">10</td>
<td align="center">2</td>
<td align="center">5</td>
<td align="center"></td>
</tr>
<tr>
<td align="left"><br></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
</tbody>
</table>
<p>We note an early focus SQLite, SQLAlchemy and Impala.
Later, work began on the Pandas backend rounding out the three different types of backgrounds.
From this point, improvements were made to these key backends as ClickHouse, Spark and PostgreSQL.
For the past two years, Quansight, in partnership with OmniSci, added the <code>ibis.omniscidb</code>
string-generating backend. Further, our responsibilities have expanded
to support Ibis as community maintainers through Quansight Labs.
This collaboration introduced <a href="http://ibis-project.org/docs/user_guide/geospatial_analysis.html">geospatial functionality to Ibis</a> for several backends.</p>
<p>There are currently ongoing efforts to introduce support for <a href="https://github.com/ibis-project/ibis/pull/1997">SQL Server</a> backends.
What other backends would you like to see for Ibis?  Maybe our community could benefit from a <a href="https://dask.org/">Dask</a>
backend or an <a href="https://www.altair.com/">Altair</a> backend?</p>
<h3>Ibis direct execution backends</h3>
<p>Ibis direct execution backends like Pandas and HDF5 operate on conventional in-memory python objects.
Pandas is the gold standard for structured data in Python and inspires the API for Ibis.</p>
<pre class="code literal-block"><span></span><code><span class="n">pd</span> <span class="o">=</span> <span class="n">ibis</span><span class="o">.</span><span class="n">pandas</span><span class="o">.</span><span class="n">connect</span><span class="p">({</span><span class="s1">'A'</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">makeDataFrame</span><span class="p">()})</span>
</code></pre>


<p>The object <code>pd</code> is an Ibis backend based on <code>pandas.DataFrame</code>.</p>
<pre class="code literal-block"><span></span><code><span class="n">expression</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">'A'</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre>


<p><code>expression</code> is an Ibis query that has <code>expression.compile</code> and <code>expression.execute</code> methods.
We'll recognize the <code>execute</code> method when we return <code>pandas.DataFrame</code>s from Ibis expression.
The <code>compile</code> method does not trigger any computation, rather it constructs an intermediate form
that is interpreted by a backend.</p>
<pre class="code literal-block"><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expression</span><span class="o">.</span><span class="n">compile</span><span class="p">(),</span> <span class="n">ibis</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">TableExpr</span><span class="p">)</span>
</code></pre>


<p>In the case of direction execution backends, the <code>expression</code> compiles to an the original Ibis
expression.  The computation itself is carried out based on a set of recipes defined in Ibis.
In general, we would typically do this work directly in Pandas; however this approach is
practical in making tests for backend-independent expressions.</p>
<h3>Ibis expression-generating backends.</h3>
<pre class="code literal-block"><span></span><code><span class="n">db</span> <span class="o">=</span> <span class="n">ibis</span><span class="o">.</span><span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">'lahmansbaseballdb.sqlite'</span><span class="p">)</span>
<span class="n">expression</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">'halloffame'</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre>


<p>Expression-generating backends operate on SQL databases that interoperate with SQLAlchemy.</p>
<pre class="code literal-block"><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expression</span><span class="o">.</span><span class="n">compile</span><span class="p">(),</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">Select</span><span class="p">)</span>
</code></pre>


<p>In the case of expression-generating backends, the intermediate representation is a <code>sqlalchemy</code> object.
SQLAlchemy is <em>the Database Toolkit for Python</em> and Ibis leverages its compatibility
with traditional SQL databases.</p>
<h3>Ibis string generating backends.</h3>
<p>There are two options for downloading Ibis: using <code>pip</code> or using <code>conda</code>.</p>
<ul>
<li>
<code>pip</code>: the extra backends from Ibis need to be requested explicitly, e.g.:</li>
</ul>
<pre class="code literal-block"><span></span><code>pip install --upgrade ibis-framework<span class="o">[</span>omniscidb<span class="o">]</span> ibis-framework<span class="o">[</span>sqlite<span class="o">]</span>
</code></pre>


<ul>
<li>
<code>conda</code>: all the supported <a href="https://ibis-project.org/docs/backends/index.html">backends</a> (e.g., <a href="https://en.wikipedia.org/wiki/SQL">SQL</a>, <a href="http://pandas.pydata.org/">Pandas</a>, <a href="https://cloud.google.com/bigquery/">BigQuery</a>, <a href="https://www.omnisci.com/">Omnisci</a>, etc.) are bundled in a single conda package and can be downloaded/installed simultaneously:</li>
</ul>
<pre class="code literal-block"><span></span><code>conda install -c conda-forge ibis-framework <span class="c1"># installs all the backends!</span>
</code></pre>


<p>String-generating backends allow Ibis to interface with big data systems that manage
their own computation. For example, we may connect to an example Omnisci database.</p>
<pre class="code literal-block"><span></span><code><span class="kn">import</span> <span class="nn">ibis.omniscidb</span>
<span class="n">omnisci</span> <span class="o">=</span> <span class="n">ibis</span><span class="o">.</span><span class="n">omniscidb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">'metis.omnisci.com'</span><span class="p">,</span>
                                 <span class="n">user</span><span class="o">=</span><span class="s1">'demouser'</span><span class="p">,</span>
                                 <span class="n">password</span><span class="o">=</span><span class="s1">'HyperInteractive'</span><span class="p">,</span>
                                 <span class="n">port</span><span class="o">=</span><span class="mi">443</span><span class="p">,</span>
                                 <span class="n">database</span><span class="o">=</span><span class="s1">'omnisci'</span><span class="p">,</span>
                                 <span class="n">protocol</span><span class="o">=</span><span class="s1">'https'</span><span class="p">)</span>
</code></pre>


<p>The <code>omnisci</code> object is described as a string-generating backend because the intermediate representation of the query is a flavor of SQL.</p>
<pre class="code literal-block"><span></span><code><span class="n">expression</span> <span class="o">=</span> <span class="n">omnisci</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">'upstream_reservoir'</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre>


<p>A string-generating expression compiles to <code>ibis.omniscidb</code> flavored SQL, while <code>ibis.bigquery</code> may have a different string representation.</p>
<pre class="code literal-block"><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">expression</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
<span class="s1">'SELECT *</span><span class="se">\n</span><span class="s1">FROM upstream_reservoir</span><span class="se">\n</span><span class="s1">LIMIT 5'</span>
</code></pre>


<h3>Acknowledgements</h3>
<p>Major credit goes to <a href="https://github.com/xmnlab">@xmnlab</a> in his heroic PR to introduce <code>ibis.omniscidb</code> into Ibis. You can watch
the drama play out in this <a href="https://github.com/ibis-project/ibis/pull/1419">Github Issue</a>. We'd like to thank the maintainers of Ibis for
their effort in supporting the Ibis community.</p>
<p>Learn more about OmniSci and <code>ibis.omniscidb</code> in this Quansight Labs post:
<a href="https://labs.quansight.org/blog/2019/07/ibis-python-data-analysis-productivity-framework/">Ibis: Python data analysis productivity framework</a>.</p>
</div>
    </div>
    <aside class="postpromonav"><nav><ul class="pager hidden-print">
<li class="previous">
                <a href="../manylinux1-is-obsolete-manylinux2010-is-almost-eol-what-is-next/" rel="prev" title="Manylinux1 is obsolete, manylinux2010 is almost EOL, what is next?">Previous post</a>
            </li>

            <li class="archive">
                <a href="../../../../archive.html" rel="archive" title="Archive ">Archive</a>
            </li>

            <li class="next">
                <a href="../introduction-to-design-in-open-source/" rel="next" title="Introduction to Design in Open Source">Next post</a>
            </li>
        </ul></nav></aside></article><!--End of body content--><footer id="footer">
            Contents © 2021         <a href="../../../../team">Quansight Labs Team</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="../../../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>
